name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install .[test]

      - name: Lint with flake8
        run: flake8

      - name: Run tests
        run: pytest -v

      - name: Build Docker image
        run: docker build -t leo-core:${{ github.sha }} .

      - name: Helm lint
        run: helm lint charts/leo-core

      - name: Extract project version
        id: project_version
        run: |
          VERSION=$(python - <<'PY'
          import tomllib

          with open('pyproject.toml', 'rb') as fh:
              data = tomllib.load(fh)
          print(data['project']['version'])
          PY
          )
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - name: Create tag
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.project_version.outputs.version }}';
            if (!version) {
              core.setFailed('Version not found');
            }
            const tag = version.startsWith('v') ? version : `v${version}`;
            const ref = `refs/tags/${tag}`;
            const { data: tags } = await github.repos.listTags({ ...context.repo, per_page: 100 });
            if (tags.some(t => t.name === tag)) {
              core.info(`Tag ${tag} already exists`);
              return;
            }
            await github.git.createRef({
              ...context.repo,
              ref,
              sha: context.sha,
            });
